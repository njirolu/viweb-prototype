const fs = require('fs/promises');
const path = require('path');

const appRoot = path.resolve(__dirname, '..');
const projectRoot = path.resolve(appRoot, '..');
const outputFile = path.join(appRoot, 'src', 'generated-files.ts');

const requiredFiles = [
  'package.json',
  'package-lock.json',
  'tsconfig.base.json',
  'app/package.json',
  'public/app.html',
  'public/app.js',
  'public/styles.css',
  'data/.gitkeep',
];

const directoriesToInclude = ['packages/server', 'packages/client', 'packages/shared'];

async function listFilesRecursively(relativeDir) {
  const absoluteDir = path.join(projectRoot, relativeDir);
  const entries = await fs.readdir(absoluteDir, { withFileTypes: true });

  const files = [];
  for (const entry of entries) {
    const childRelativePath = path.posix.join(relativeDir, entry.name);

    if (entry.isDirectory()) {
      const nestedFiles = await listFilesRecursively(childRelativePath);
      files.push(...nestedFiles);
      continue;
    }

    if (entry.isFile()) {
      files.push(childRelativePath);
    }
  }

  return files;
}

function setFileNode(tree, relativePath, contents) {
  const parts = relativePath.split('/');
  let cursor = tree;

  for (let index = 0; index < parts.length; index += 1) {
    const part = parts[index];
    const isLeaf = index === parts.length - 1;

    if (isLeaf) {
      cursor[part] = {
        file: {
          contents,
        },
      };
      return;
    }

    if (!cursor[part]) {
      cursor[part] = {
        directory: {},
      };
    }

    if (!cursor[part].directory || typeof cursor[part].directory !== 'object') {
      throw new Error(`Invalid directory node generated for path segment: ${part}`);
    }

    cursor = cursor[part].directory;
  }
}

async function readTextFile(relativePath) {
  const absolutePath = path.join(projectRoot, relativePath);
  return fs.readFile(absolutePath, 'utf8');
}

async function main() {
  const directoryFiles = (
    await Promise.all(directoriesToInclude.map((relativeDir) => listFilesRecursively(relativeDir)))
  ).flat();

  const selectedFiles = [...new Set([...requiredFiles, ...directoryFiles])].sort();

  const fileTree = {};
  for (const relativePath of selectedFiles) {
    const contents = await readTextFile(relativePath);
    setFileNode(fileTree, relativePath, contents);
  }

  const moduleContents = [
    '// This file is auto-generated by app/scripts/generate-webcontainer-files.js',
    '// Do not edit manually.',
    '',
    `export const projectFiles = ${JSON.stringify(fileTree, null, 2)} as const;`,
    '',
  ].join('\n');

  await fs.mkdir(path.dirname(outputFile), { recursive: true });
  await fs.writeFile(outputFile, moduleContents, 'utf8');

  console.log(`Generated ${path.relative(projectRoot, outputFile)} with ${selectedFiles.length} files.`);
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
